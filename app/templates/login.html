<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DECIDERO GDSS - Login</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/assets/images/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/assets/images/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/assets/images/favicon_io/favicon-16x16.png">
    <link rel="shortcut icon" href="/static/assets/images/favicon_io/favicon.ico">
    <link rel="manifest" href="/static/assets/images/favicon_io/site.webmanifest">
    <link rel="stylesheet" href="/static/css/login.css">
</head>
<body>
    <div class="login-container">
        <div class="terminal-effect"></div>
        <div class="loading" style="display: none;"></div>
        
        <!-- First-time setup alert -->
        {% if show_setup_alert %}
        {% grab id="login-setup-alert" %}
        <div class="setup-alert" style="background-color: #f7a532; color: #000; padding: 1rem; margin: 1rem 0; border-radius: 4px; text-align: center; font-weight: bold;">
            FIRST-TIME SETUP: Create an Admin Account
            <div style="font-size: 0.9em; margin-top: 0.5rem;">
                <a href="/register" style="color: #000; text-decoration: underline;">Click here to register</a>
            </div>
        </div>
        {% endgrab %}
        {% endif %}
        
        {% grab id="login-header" %}
        <div class="login-header">
            <img
                src="/static/assets/images/logo-120.png"
                srcset="/static/assets/images/logo-120.png 1x, /static/assets/images/logo-360.png 3x, /static/assets/images/logo-720.png 6x"
                alt="Decidero Logo"
                class="decidero-logo"
            >
            <h1>DECIDERO</h1>
            <p>GROUP DECISION SUPPORT SYSTEM</p>
        </div>
        {% endgrab %}

        {% grab id="login-form" %}
        <form class="login-form" id="loginForm"> <!-- Removed method and action -->
            <div class="form-group">
                <label for="login">USERNAME</label>
                <input type="text" id="login" name="login" required
                       autocomplete="username" spellcheck="false">
            </div>

            <div class="form-group">
                <label for="password">PASSWORD</label>
                <input type="password" id="password" name="password" required
                       autocomplete="current-password">
            </div>
            
            <div class="error-message" id="errorMessage" style="display: none;"></div>
            <button type="submit" class="submit-btn">LOGIN</button>
        </form>
        {% endgrab %}
        {% grab id="login-register-cta" %}
        <div style="text-align: center; margin-top: 1.5rem;">
            <p style="margin-bottom: 0.5rem; color: var(--silver); font-size: 0.9rem;">Don't have an account?</p>
            <a href="/register" class="submit-btn" style="display: inline-block; width: auto; padding: 0.75rem 1.5rem; text-decoration: none;">Register</a>
        </div>
        {% endgrab %}
    </div>
    <footer class="auth-site-footer" aria-label="Project links">
        <a href="/about">About</a>
        <span aria-hidden="true">·</span>
        <a href="https://github.com/JohnKruse/decidero_gdss_public" target="_blank" rel="noopener noreferrer">GitHub</a>
        <span aria-hidden="true">·</span>
        <a href="https://github.com/JohnKruse/decidero_gdss_public/blob/main/LICENSE" target="_blank" rel="noopener noreferrer">License</a>
    </footer>

    <script>
        const loginForm = document.getElementById('loginForm');
        const errorMessageDiv = document.getElementById('errorMessage');
        const loadingDiv = document.querySelector('.loading');

        const showMessage = (text, color = "") => {
            errorMessageDiv.textContent = text;
            errorMessageDiv.style.color = color;
            errorMessageDiv.style.display = 'block';
        };

        const hideMessage = () => {
            errorMessageDiv.style.display = 'none';
            errorMessageDiv.style.color = "";
        };

        // Display errors from URL query parameters (e.g., if redirected from a protected page)
        const urlParams = new URLSearchParams(window.location.search);
        const errorParam = urlParams.get('error');
        if (errorParam) {
            showMessage(decodeURIComponent(errorParam));
        }
        const messageParam = urlParams.get('message');
        if (messageParam === 'registration_success') {
             // Optionally show a success message before auto-redirect or upon successful login
            showMessage("Registration successful! Please log in.", "green");
        }


        loginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            hideMessage(); // Hide previous errors
            loadingDiv.style.display = 'block'; // Show loading indicator

            const login = document.getElementById('login').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('/api/auth/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ username: login, password: password }),
                });

                loadingDiv.style.display = 'none'; // Hide loading indicator

                if (response.ok) {
                    const data = await response.json();
                    // Cookie is set by the server (httponly).
                    // Redirect to dashboard on successful login.
                    // Check for needs_password_change if implementing that flow
                    if (data.needs_password_change) {
                        // Redirect to a password change page, or handle as needed
                        // For now, just go to dashboard
                        window.location.href = '/dashboard?message=login_success_change_pw';
                    } else {
                        window.location.href = '/dashboard?message=login_success';
                    }
                } else {
                    const errorData = await response.json().catch(() => ({ detail: "Login failed. Please check your credentials." }));
                    showMessage(errorData.detail || "Login failed. Please try again.");
                }
            } catch (error) {
                loadingDiv.style.display = 'none'; // Hide loading indicator
                console.error('Login request failed:', error);
                showMessage("Login request failed. Please try again later.");
            }
        });

        // Add retro terminal effect on input focus (from original script)
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('focus', () => {
                input.style.borderColor = 'var(--terminal-green)'; // Assuming --terminal-green is defined or use a known color
                input.style.backgroundColor = 'rgba(51, 255, 51, 0.05)';
            });
            input.addEventListener('blur', () => {
                input.style.borderColor = '';
                input.style.backgroundColor = '';
            });
        });
    </script>
{% if grab_enabled() %}
<script src="/static/grab.js"></script>
{% endif %}
</body>
</html>
