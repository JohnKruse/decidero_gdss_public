{% extends "_base.html" %}

{% block title %}{{ meeting.title }} – Meeting - Decidero GDSS{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/meeting.css?v=20260130a">
{% endblock %}

{% block top_nav_right %}
<a href="/dashboard" class="profile-link">Back to Dashboard</a>
{% endblock %}

{% block content %}
{% from "components/macros.html" import section_header %}
<div class="meeting-page page-shell" data-meeting-root data-meeting-id="{{ meeting_id }}"
    data-user-login="{{ current_user.login if current_user else '' }}"
    data-user-id="{{ current_user.user_id if current_user else '' }}"
    data-user-role="{{ ((current_user.role.value if current_user and current_user.role.value is defined else (current_user.role if current_user else 'guest'))) | lower }}"
    data-view-mode="{{ 'facilitator' if current_user.role in ['admin', 'super_admin', 'facilitator'] else 'participant' }}"
    data-brainstorm-max-length="{{ brainstorming_limits.idea_character_limit | default(500) }}"
    data-brainstorm-max-ideas="{{ brainstorming_limits.max_ideas_per_user | default(0) }}"
    data-meeting-refresh-enabled="{{ 'true' if meeting_refresh.get('enabled', True) else 'false' }}"
    data-meeting-refresh-interval-seconds="{{ meeting_refresh.get('interval_seconds', 8) }}"
    data-meeting-refresh-hidden-interval-seconds="{{ meeting_refresh.get('hidden_interval_seconds', 45) }}"
    data-meeting-refresh-failure-backoff-seconds="{{ meeting_refresh.get('failure_backoff_seconds', 60) }}">
    {% grab id="meeting-overview-card" %}
    <section class="content-card meeting-overview-card">
        <div class="meeting-overview-top">
            <div class="meeting-overview-text">
                <h1 id="meetingOverviewTitle">{{ meeting.title }}</h1>
                <p id="meetingOverviewDescription">{{ meeting.description or "No description provided yet." }}</p>
            </div>
            <span class="connection-indicator" id="meetingConnectionStatus" data-status-variant="pending">
                Connecting…
            </span>
        </div>
        <div class="meeting-overview-meta">
            <div class="meeting-overview-meta-item">
                <span class="meeting-overview-label">Meeting status</span>
                <div class="meeting-overview-status">
                    <strong id="meetingOverviewStatusTitle">Waiting to join</strong>
                    <span class="meeting-status-pill" id="meetingOverviewStatusBadge"
                        data-variant="muted">Waiting</span>
                </div>
            </div>
            <div class="meeting-overview-meta-item">
                <span class="meeting-overview-label">Facilitator</span>
                <strong id="meetingOverviewFacilitator">—</strong>
            </div>
            {% if current_user.role in ['admin', 'super_admin', 'facilitator'] %}
            <div class="meeting-overview-meta-item">
                <span class="meeting-overview-label">Activity log</span>
                <a class="control-btn sm meeting-log-button" href="/meeting/{{ meeting_id }}/activity-log"
                    target="_blank" rel="noopener">
                    Open log
                </a>
            </div>
            {% endif %}
        </div>
        <div id="meetingAccessMessage" class="meeting-access" hidden></div>
    </section>
    {% endgrab %}

    <div class="layout-grid">
        <div class="meeting-main">
            {% grab id="meeting-agenda-card" %}
            <section class="content-card meeting-agenda-card">
                <div class="section-header agenda-header">
                    <div>
                        <div class="agenda-title-row">
                            <h2>Agenda</h2>
                            <div class="agenda-summary" aria-live="polite">
                                <span class="agenda-summary-pill" id="agendaSummaryTotal">0 activities</span>
                                <span class="agenda-summary-pill" id="agendaSummaryActive">0 active</span>
                            </div>
                        </div>
                        <div class="overview-subtitle">Pick an activity to see facilitator guidance and configuration.
                        </div>
                    </div>
                    <button type="button" class="control-btn sm agenda-collapse-toggle" id="agendaCollapseToggle"
                        aria-expanded="true" aria-controls="agendaSectionBody">
                        Collapse
                    </button>
                </div>
                <div class="section-body" id="agendaSectionBody">
                    <ol class="agenda-timeline" id="meetingAgendaList"></ol>
                    {% if current_user.role in ['admin', 'super_admin', 'facilitator'] %}
                    <div class="card-actions">
                    <button type="button" class="control-btn" id="agendaAddActivityButton">Settings</button>
                    </div>
                    {% endif %}
                </div>
            </section>
            {% endgrab %}

            {% grab id="meeting-brainstorming-panel" %}
            <section class="content-card activity-panel brainstorming-panel" data-brainstorming-root hidden>
                <div class="section-header">
                    <h2 id="brainstormingHeaderTitle">Brainstorming</h2>
                    <div class="overview-subtitle">Capture ideas quickly and surface them to the group.</div>
                </div>
                <div class="section-body">
                    <p id="brainstormingDescription" class="brainstorming-description">
                        The session facilitator will start the brainstorming activity.
                    </p>
                    <div id="brainstormingError" class="brainstorming-error" hidden></div>
                    <form class="brainstorming-form" data-brainstorming-form>
                        <textarea name="idea" id="brainstormingIdeaInput" placeholder="Share an idea…"
                            maxlength="{{ brainstorming_limits.idea_character_limit | default(500) }}"
                            required></textarea>
                        <div class="brainstorming-form-footer">
                            <p class="brainstorming-profile-note">
                                Ideas use your profile display name unless this round is anonymous.
                            </p>
                            <label class="brainstorming-scroll-toggle">
                                <input type="checkbox" id="brainstormingAutoJumpToggle" />
                                <span>Auto-jump to newest idea</span>
                            </label>
                            <button type="submit" class="control-btn primary" id="brainstormingSubmitButton" disabled>
                                Submit Idea
                            </button>
                        </div>
                    </form>
                    <div class="brainstorming-ideas">
                        <h3>Ideas</h3>
                        <div id="brainstormingIdeasList" class="brainstorming-ideas-list">
                            <table class="brainstorming-ideas-table">
                                <thead>
                                    <tr>
                                        <th class="idea-col-number">#</th>
                                        <th class="idea-col-text">Idea</th>
                                        <th class="idea-col-author">Author</th>
                                        <th class="idea-col-time">Time</th>
                                        <th class="idea-col-menu"></th>
                                    </tr>
                                </thead>
                                <tbody id="brainstormingIdeasBody">
                                    <tr class="brainstorming-empty-row">
                                        <td colspan="5">No ideas yet. Be the first to share!</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            {% endgrab %}

            {% grab id="meeting-transfer-panel" %}
            <section class="content-card activity-panel transfer-panel" data-transfer-root hidden>
                <div class="section-header transfer-header">
                    <div>
                        <h2 id="transferHeaderTitle">Transfer Ideas</h2>
                        <div class="overview-subtitle transfer-donor-title" id="transferDonorTitle">Select a
                            brainstorming activity.</div>
                    </div>
                    <div class="transfer-actions">
                        <select id="transferTargetToolType" class="form-select transfer-target-select"></select>
                        <label class="transfer-toggle">
                            <input type="checkbox" id="transferIncludeComments" checked>
                            <span>Include comments</span>
                        </label>
                        <button type="button" class="control-btn sm" id="transferAddIdea">Add Idea</button>
                        <button type="button" class="control-btn sm" id="saveTransferDraft">Save Draft</button>
                        <button type="button" class="control-btn sm primary" id="commitTransfer">Create Next
                            Activity</button>
                        <button type="button" class="control-btn sm" id="closeTransferPanel">Back to Activity</button>
                    </div>
                </div>
                <div class="section-body">
                    <div id="transferStatus" class="control-feedback" aria-live="polite"></div>
                    <div id="transferError" class="brainstorming-error" hidden></div>
                    <div class="brainstorming-ideas-list transfer-ideas-list" id="transferIdeasList">
                        <table class="brainstorming-ideas-table transfer-ideas-table">
                            <thead>
                                <tr>
                                    <th class="idea-col-number">#</th>
                                    <th class="idea-col-text">Idea</th>
                                    <th class="idea-col-author">Author</th>
                                    <th class="idea-col-time">Time</th>
                                    <th class="idea-col-menu"></th>
                                </tr>
                            </thead>
                            <tbody id="transferIdeasBody">
                                <tr class="brainstorming-empty-row">
                                    <td colspan="5">No ideas available.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
            {% endgrab %}

            {% grab id="meeting-voting-panel" %}
            <section class="content-card activity-panel voting-panel" data-voting-root hidden>
                {{ section_header('Dot Voting', 'Distribute votes across ideas to prioritise the strongest options.') }}
                <div class="section-body">
                    <p id="votingInstructions" class="voting-description">
                        The facilitator will open voting when ready.
                    </p>
                    <p id="votingResultsNotice" class="voting-notice"></p>
                    <p class="voting-remaining">Remaining picks: <strong id="votingRemaining">0</strong></p>
                    <div id="votingError" class="brainstorming-error" hidden></div>
                    <ul class="voting-options" id="votingOptionsList">
                        <li class="voting-option voting-option-empty">Voting is not active.</li>
                    </ul>
                    <div class="voting-footer" id="votingFooter" hidden>
                        <div class="voting-footer-main">
                            <p class="voting-footer-progress" id="votingProgressMessage"></p>
                            <div class="voting-footer-actions">
                                <button type="button" class="control-btn sm" id="votingResetButton" disabled>
                                    Reset
                                </button>
                                <button type="button" class="control-btn sm primary" id="votingSubmitButton" disabled>
                                    Submit
                                </button>
                                <button type="button" class="control-btn sm" id="votingViewResultsButton" hidden>
                                    View Results
                                </button>
                            </div>
                        </div>
                        <div id="votingStatus" class="control-feedback" aria-live="polite"></div>
                    </div>
                </div>
            </section>
            {% endgrab %}

            {% grab id="meeting-categorization-panel" %}
            <section class="content-card activity-panel categorization-panel" data-categorization-root hidden>
                {{ section_header('Bucketing / Categorization', 'Group ideas into buckets and refine categories in real time.') }}
                <div class="section-body">
                    <p id="categorizationInstructions" class="voting-description">
                        The facilitator will open categorization when ready.
                    </p>
                    <div id="categorizationError" class="brainstorming-error" hidden></div>
                    <div class="categorization-toolbar">
                        <button type="button" class="control-btn sm" id="categorizationSubmitBallotButton">Submit Ballot</button>
                        <button type="button" class="control-btn sm" id="categorizationUnsubmitBallotButton">Unsubmit Ballot</button>
                        <button type="button" class="control-btn sm" id="categorizationRevealButton">Reveal</button>
                        <label class="categorization-lock-toggle" for="categorizationLockToggle">
                            <span class="categorization-lock-label">Unlocked</span>
                            <input type="checkbox" id="categorizationLockToggle" />
                            <span class="categorization-lock-slider" aria-hidden="true"></span>
                            <span class="categorization-lock-label">Locked</span>
                        </label>
                        <button type="button" class="control-btn sm" id="categorizationRefreshButton">Refresh</button>
                    </div>
                    <div class="categorization-board">
                        <div class="categorization-column">
                            <h3 id="categorizationOpenBucketTitle">Open Bucket Contents</h3>
                            <ul id="categorizationItemsList" class="categorization-list">
                                <li class="categorization-item-empty">No items available.</li>
                            </ul>
                        </div>
                        <div class="categorization-column">
                            <h3>Buckets (Drop Target)</h3>
                            <div class="categorization-bucket-controls">
                                <button type="button" class="control-btn sm" id="categorizationAddBucketButton">Add Bucket</button>
                                <button type="button" class="control-btn sm" id="categorizationEditBucketButton">Edit Bucket</button>
                                <button type="button" class="control-btn sm" id="categorizationDeleteBucketButton">Delete Bucket</button>
                            </div>
                            <ul id="categorizationBucketsList" class="categorization-list">
                                <li class="categorization-item-empty">No buckets available.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>
            {% endgrab %}

            {% grab id="meeting-generic-activity-panel" %}
            <section class="content-card activity-panel generic-activity-panel" data-generic-tool hidden>
                {{ section_header('Active Activity') }}
                <div class="section-body">
                    <h3 id="genericToolTitle">Activity Active</h3>
                    <p id="genericToolDescription">
                        Your facilitator will guide the current activity.
                    </p>
                </div>
            </section>
            {% endgrab %}
        </div>

    </div>
    <div id="participantAdminModal" class="modal-overlay" hidden>
        <div class="modal-content participant-modal-content">
            <div class="modal-header">
                <div class="participant-modal-heading">
                    <h2 id="participantModalTitle">Manage Meeting Participants</h2>
                    <div id="participantModalActivityMeta" class="participant-modal-activity-meta" hidden>
                        <span class="participant-modal-activity-label">Activity:</span>
                        <span id="participantModalActivityName" class="participant-modal-activity-name"></span>
                        <span class="participant-modal-activity-label">Type:</span>
                        <span id="participantModalActivityType" class="participant-modal-activity-type"></span>
                    </div>
                </div>
                <button type="button" class="close-button" id="closeParticipantAdminModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="participant-modal-tabs" role="tablist">
                    <button type="button" class="control-btn sm" data-participant-modal-tab="meeting"
                        data-active="true">
                        Meeting Participants
                    </button>
                    <button type="button" class="control-btn sm" data-participant-modal-tab="activity">
                        Activity Roster
                    </button>
                </div>
                <div class="participant-modal-panel" data-participant-admin-panel>
                    <div class="participant-admin" data-participant-admin>
                        <h3>Manage Participants</h3>
                        <p class="activity-participant-hint">
                            Participants are meeting attendees. Adding an admin or facilitator here does not make them a meeting facilitator.
                        </p>
                        <form id="participantAssignForm" class="participant-manage-form">
                            <input type="text" id="participantAssignLogin" class="form-input"
                                placeholder="Add by login…" maxlength="120">
                            <button type="submit" class="control-btn primary" id="participantAssignButton">Add</button>
                        </form>
                        <div class="participant-selection-grid participant-selection-grid--modal">
                            <div class="participant-column">
                                <div class="participant-column-header">
                                    <h4>Available Users</h4>
                                    <div class="participant-column-actions">
                                        <button type="button" class="control-btn sm"
                                            id="meetingAvailableSelectAllButton" disabled>
                                            Select All
                                        </button>
                                    </div>
                                </div>
                                <div class="participant-directory-panel">
                                    <div class="participant-directory-search">
                                        <input type="text" id="meetingDirectorySearch" class="form-input"
                                            placeholder="Search name, login, or email…" maxlength="120">
                                        <button type="button" class="control-btn sm" id="meetingDirectoryClearButton"
                                            disabled>Clear Selection</button>
                                    </div>
                                    <div id="meetingDirectoryStatus" class="control-feedback" aria-live="polite"></div>
                                    <div id="meetingDirectoryList" class="participant-directory-list" role="listbox"
                                        aria-multiselectable="true">
                                        <div class="participant-directory-empty">Search the directory to find users you
                                            can assign to this meeting.</div>
                                    </div>
                                    <div class="participant-directory-footer">
                                        <div class="participant-directory-pagination">
                                            <button type="button" class="control-btn sm"
                                                id="meetingDirectoryPrev">Previous</button>
                                            <span id="meetingDirectoryPageLabel">Page 1 of 1</span>
                                            <button type="button" class="control-btn sm"
                                                id="meetingDirectoryNext">Next</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="participant-transfer-controls">
                                <button type="button" class="transfer-btn" id="meetingMoveToSelectedButton" disabled
                                    aria-label="Add to meeting">→</button>
                                <button type="button" class="transfer-btn" id="meetingMoveToAvailableButton" disabled
                                    aria-label="Remove from meeting">←</button>
                            </div>

                            <div class="participant-column">
                                <div class="participant-column-header">
                                    <h4>Selected Participants</h4>
                                    <div class="participant-column-actions">
                                        <button type="button" class="control-btn sm" id="meetingSelectedSelectAllButton"
                                            disabled>
                                            Select All
                                        </button>
                                    </div>
                                </div>
                                <div class="participant-directory-panel participant-directory-panel--selected">
                                    <div class="participant-directory-status">
                                        <span id="meetingSelectedStatus" class="muted-note">No participants
                                            selected.</span>
                                    </div>
                                    <div id="meetingSelectedList"
                                        class="participant-directory-list participant-directory-list--selected"
                                        role="listbox" aria-multiselectable="true">
                                        <div class="participant-directory-empty">No participants selected yet.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="participantAdminFeedback" class="control-feedback" aria-live="polite"></div>
                    </div>
                </div>
                <div class="participant-modal-panel" data-activity-roster-panel hidden>
                    <div class="activity-participant-admin" data-activity-participant-admin>
                        <p class="activity-participant-hint">By default everyone joins this activity. Remove
                            participants here before launching if you need a breakout.</p>
                        <div class="activity-participant-actions">
                            <button type="button" class="control-btn" id="activityParticipantIncludeAll">Include
                                Everyone</button>
                            <button type="button" class="control-btn" id="activityParticipantReuse" hidden>Reuse
                                Last</button>
                            <button type="button" class="control-btn primary" id="activityParticipantApply"
                                disabled>Apply Selection</button>
                        </div>
                        <div id="activityParticipantFeedback" class="control-feedback" aria-live="polite"></div>
                        <div class="participant-selection-grid participant-selection-grid--modal">
                            <div class="participant-column">
                                <div class="participant-column-header">
                                    <h4>Available Participants</h4>
                                    <div class="participant-column-actions">
                                        <button type="button" class="control-btn sm"
                                            id="activityAvailableSelectAllButton" disabled>
                                            Select All
                                        </button>
                                    </div>
                                </div>
                                <div class="participant-directory-panel">
                                    <ul id="activityParticipantChecklist" class="participant-directory-list"
                                        role="listbox" aria-multiselectable="true">
                                        <div class="participant-directory-empty">Loading activity participants…</div>
                                    </ul>
                                </div>
                            </div>

                            <div class="participant-transfer-controls">
                                <button type="button" class="transfer-btn" id="activityMoveToSelectedButton" disabled
                                    aria-label="Add to activity">→</button>
                                <button type="button" class="transfer-btn" id="activityMoveToAvailableButton" disabled
                                    aria-label="Remove from activity">←</button>
                            </div>

                            <div class="participant-column">
                                <div class="participant-column-header">
                                    <h4>Selected Participants</h4>
                                    <div class="participant-column-actions">
                                        <button type="button" class="control-btn sm"
                                            id="activitySelectedSelectAllButton" disabled>
                                            Select All
                                        </button>
                                    </div>
                                </div>
                                <div class="participant-directory-panel participant-directory-panel--selected">
                                    <ul id="activityParticipantSelectedList"
                                        class="participant-directory-list participant-directory-list--selected"
                                        role="listbox" aria-multiselectable="true">
                                        <div class="participant-directory-empty">Select participants to assign.</div>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="collisionModal" class="modal-overlay" hidden>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Participant Collision Detected!</h2>
                <button type="button" class="close-button" id="closeCollisionModal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Starting this activity would cause conflicts for the following participants who are already active in
                    another activity:</p>
                <ul id="conflictingParticipantsList" class="simple-list">
                    <!-- Conflicting participants will be listed here -->
                </ul>
                <p>Please re-assign these participants or stop the active activity before starting this one.</p>
                <div class="form-actions">
                    <button type="button" class="control-btn" id="cancelCollision">Cancel</button>
                    <!-- Future: Add button to go to roster editing if needed -->
                </div>
            </div>
        </div>
    </div>

    <div id="votingResultsModal" class="modal-overlay" hidden>
        <div class="modal-content voting-results-modal">
            <div class="modal-header">
                <h2>Voting Results</h2>
                <button type="button" class="close-button" id="closeVotingResultsModal">&times;</button>
            </div>
            <div class="modal-body">
                <table id="votingResultsTable" class="voting-results-table">
                    <thead>
                        <tr>
                            <th class="votes-col">Total Votes</th>
                            <th class="idea-col">Idea</th>
                        </tr>
                    </thead>
                    <tbody id="votingResultsBody">
                        <tr>
                            <td colspan="2">No results available.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
{# Cache-bust to ensure browsers pick up latest meeting scripts #}
<script src="/static/js/realtime_client.js?v=20241215b"></script>
<script src="/static/js/meeting.js?v=20260130b"></script>
{% endblock %}
